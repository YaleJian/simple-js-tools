!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).miniSDK=t()}(this,(function(){"use strict";var e={isArray:e=>Array.isArray(e),isObject:e=>"[object Object]"===Object.prototype.toString.call(e),isPromise:e=>"[object Promise]"===Object.prototype.toString.call(e)};const t={deepCopy(...o){let n,s,r,i,a,p,d=o[0]||{},c=1,h=o.length;for(1===h&&(d=this,c=0);c<h;c++)if(n=o[c],n)for(s in n)i=n[s],"_proto_"!==s&&d[s]!==i&&(i&&(e.isObject(i)||(a=e.isArray(i)))?(r=d[s],p=a&&!e.isArray(r)?[]:a||e.isObject(r)?r:{},a=!1,d[s]=t.deepCopy(p,i)):void 0!==i&&(d[s]=i));return d}};window._XMLHttpRequest=window.XMLHttpRequest,window._ActiveXObject=window.ActiveXObject;try{new window.Event("config")}catch(e){window.Event=function(e,t,o,n){let s=document.createEvent("CustomEvent");return s.initCustomEvent(e,t,o,n),s}}let o={UNSENT:0,OPENED:1,HEADERS_RECEIVED:2,LOADING:3,DONE:4},n="readystatechange loadstart progress abort error load timeout loadend".split(" "),s="timeout withCredentials".split(" "),r="readyState responseURL status statusText responseType response responseText responseXML".split(" "),i={100:"Continue",101:"Switching Protocols",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",300:"Multiple Choice",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Requested Range Not Satisfiable",417:"Expectation Failed",422:"Unprocessable Entity",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported"};function a(){this.config={events:{},headers:{}},this.proxy=!1,this.debug=!1}return t.deepCopy(a,o),t.deepCopy(a.prototype,o),a.prototype.mock=!0,a.prototype.noProxy=!1,t.deepCopy(a.prototype,{open:function(e,o,i,p,d){let c=this;function h(e){for(let e=0;e<r.length;e++)try{c[r[e]]=xhr[r[e]]}catch(e){}c.dispatchEvent(new Event(e.type))}if(t.deepCopy(this.config,{method:e,url:o,async:"boolean"!=typeof i||i,username:p,password:d,body:"",options:{url:o,method:e}}),this.noProxy||this.proxy){let t=function(){let e=function(){let e=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,t=/^([\w.+-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,o=location.href,n=t.exec(o.toLowerCase())||[];return e.test(n[1])}();return window.ActiveXObject?!e&&t()||o():t();function t(){try{return new window._XMLHttpRequest}catch(e){}}function o(){try{return new window._ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}}();this.config.xhr=t;for(let e=0;e<n.length;e++)t.addEventListener(n[e],h);p?t.open(e,o,i,p,d):t.open(e,o,i);for(let e=0;e<s.length;e++)try{t[s[e]]=c[s[e]]}catch(e){}}else this.readyState=a.OPENED,this.dispatchEvent(new Event("readystatechange"))},setRequestHeader:function(e,t){if(this.noProxy||this.proxy)return void this.config.xhr.setRequestHeader(e,t);let o=this.config.headers;o[e]?o[e]+=","+t:o[e]=t},timeout:0,withCredentials:!1,upload:{},send:function(t){let o=this;if(this.config.body=t,this.config.timeout=this.timeout,this.noProxy||this.proxy)this.config.xhr.send(t);else if(this.setRequestHeader("X-Requested-With","MockXHR"),this.dispatchEvent(new Event("loadstart")),o.readyState=a.HEADERS_RECEIVED,o.dispatchEvent(new Event("readystatechange")),o.readyState=a.LOADING,o.dispatchEvent(new Event("readystatechange")),a.proxy){a.debug&&console.log("[XHR] 请求xhr:",o.config);let t=a.proxy(o);e.isPromise(t)&&t.then((e=>{n(e)})).catch((e=>{n(e)}))}else console.warn("[tools-xhr] proxy param is not a Promise");function n(e,t){a.debug&&console.log("[XHR] 响应data:",e),e.responseHeaders&&(o.responseHeaders=e.responseHeaders),e.response&&(o.response=e.response||""),"string"==typeof e.response&&(o.responseText=e.response),e.responseType&&(o.responseType=e.responseType),e.responseURL&&(o.responseURL=e.responseURL),e.responseXML&&(o.responseXML=e.responseXML),o.status=e.status||200,o.statusText=e.statusText||i[o.status],e.timeout&&(o.timeout=e.timeout),e.withCredentials&&(o.withCredentials=e.withCredentials),o.readyState=a.DONE,o.dispatchEvent(new Event("readystatechange")),o.dispatchEvent(new Event("load")),o.dispatchEvent(new Event("loadend"))}},abort:function(){this.noProxy?this.config.xhr.abort():(this.readyState=a.UNSENT,this.dispatchEvent(new Event("abort",!1,!1,this)),this.dispatchEvent(new Event("error",!1,!1,this)))}}),t.deepCopy(a.prototype,{status:a.UNSENT,statusText:"",getResponseHeader:function(e){return this.noProxy||this.proxy?this.config.xhr.getResponseHeader(e):this.responseHeaders[e.toLowerCase()]},getAllResponseHeaders:function(){if(this.noProxy||this.proxy)return this.config.xhr.getAllResponseHeaders();let e=this.responseHeaders,t="";for(let o in e)e.hasOwnProperty(o)&&(t+=o+": "+e[o]+"\r\n");return t},overrideMimeType:function(){},responseHeaders:{},responseURL:"",responseType:"",response:null,responseText:"",responseXML:null}),t.deepCopy(a.prototype,{addEventListener:function(e,t){let o=this.config.events;o[e]||(o[e]=[]),o[e].push(t)},removeEventListener:function(e,t){let o=this.config.events[e]||[];for(let e=0;e<o.length;e++)o[e]===t&&o.splice(e--,1)},dispatchEvent:function(e){let t=this.config.events[e.type]||[];for(let o=0;o<t.length;o++)t[o].call(this,e);let o="on"+e.type;this[o]&&this[o](e)}}),{xhr:a,object:t,compare:e}}));